<script setup lang="ts">
import type { MoneyTypeSlug } from '~/components/stat/types'
import type { WalletId } from '~~/components/wallets/types'
import { type TransferType, TrnType } from '~/components/trns/types'
import { useTrnFormStore } from '~/components/trnForm/useTrnForm'
import { useWalletsStore } from '~/components/wallets/useWalletsStore'

const $trnForm = useTrnFormStore()
const walletsStore = useWalletsStore()

const items = ref<Record<MoneyTypeSlug, {
  transferType: TransferType
  amountsIdx: 1 | 2
}>>({
  expense: {
    transferType: 0,
    amountsIdx: 1,
  },
  income: {
    transferType: 1,
    amountsIdx: 2,
  },
})

const incomeWalletId = computed<WalletId | null>(() =>
  $trnForm.values.incomeWalletId ?? walletsStore.walletsSortedIds[0],
)

const expenseWalletId = computed<WalletId | null>(() =>
  $trnForm.values.expenseWalletId ?? walletsStore.walletsSortedIds[1],
)

watch(() => $trnForm.values.trnType, (trnType) => {
  if (trnType === TrnType.Transfer) {
    $trnForm.values.incomeWalletId = incomeWalletId.value
    $trnForm.values.expenseWalletId = expenseWalletId.value
  }
}, { immediate: true })
</script>

<template lang="pug">
.pb-2
  .flex.flex-col
    .cursor-pointer.overflow-hidden.rounded-md(
      v-for="(item, slug) in items"
      :key="slug"
      :class="[{ '!bg-item-3': $trnForm.values.transferType === item.transferType }]"
      @click="$trnForm.onChangeTransferType(item.transferType)"
    )
      //- Wallet name
      .px-3.pt-2.grid.items-center.whitespace-nowrap(
        class="grid-cols-[.4fr,1fr]"
      )
        .grow.text-sm(class="w-1/2 text-primary/70") {{ $t(slug) }}
        template(v-if="slug === 'income'")
          TrnFormMainSelectedWallet(
            :key="incomeWalletId"
            :id="incomeWalletId"
            @click="$trnForm.openTrnFormModal('transferTo')"
          )
        template(v-if="slug === 'expense'")
          TrnFormMainSelectedWallet(
            :key="expenseWalletId"
            :id="expenseWalletId"
            @click="$trnForm.openTrnFormModal('transferFrom')"
          )

      //- Input
      TrnFormMainInput(
        :key="item.amountsIdx"
        :amount="$trnForm.values.amount[item.amountsIdx]"
        :amountRaw="$trnForm.values.amountRaw[item.amountsIdx]"
        :highlight="item.transferType === 1 ? 'expense' : 'income'"
        :isShowSum="$trnForm.getIsShowSum(item.amountsIdx)"
        isTransfer
        @onChange="$trnForm.onChangeAmount"
      )
</template>

<i18n lang="yaml">
en:
  expense: Transfer from
  income: Transfer to
ru:
  expense: Перевод из
  income: Перевод в
</i18n>
